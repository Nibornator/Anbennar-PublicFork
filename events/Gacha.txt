namespace = gacha

country_event = {
	id = gacha.1
	title = gacha.1.t
	desc = gacha.1.d
	picture = ANGRY_MOB_eventPicture
	
	is_triggered_only = yes
	hidden = yes

	trigger = {
		ai = no
	}

	immediate = {
		hidden_effect = {
			capital_scope = {
				remove_province_triggered_modifier = gacha_randomness_ptm
			}
		}
	}

	option = {
		name = gacha.1.a
		ai_chance = { factor = 1 }

		8 = {
			set_variable = {
				top_ticket_weight = 0
			}
		}

		# Finding winner
		every_country = {
			limit = {
				ai = no
			}

			set_variable = {
				ticket_weight = 0
			}

			set_variable = {
				which = tickets_counter
				which = tickets
			}

			while = {
				limit = {
					check_variable = {
						tickets_counter = 1
					}
				}

				# This part replaces what would be regular random if it was possible
				random_list = {
					1 = { }
					1 = { 
						change_variable = { ticket_weight = 1 } 
						modifier = { factor = 0.3 has_already_won_gatcha = yes }
					}
					1 = { 
						change_variable = { ticket_weight = 2 } 
						modifier = { factor = 0.3 has_already_won_gatcha = yes }
					}
					1 = { 
						change_variable = { ticket_weight = 3 } 
						modifier = { factor = 0.3 has_already_won_gatcha = yes }
					}
					1 = { 
						change_variable = { ticket_weight = 4 } 
						modifier = { factor = 0.3 has_already_won_gatcha = yes }
					}
					1 = { 
						change_variable = { ticket_weight = 5 } 
						modifier = { factor = 0.3 has_already_won_gatcha = yes }
					}
				}

				subtract_variable = {
					tickets_counter = 1
				}
			}

			8 = {
				set_variable = { which = ticket_weight which = PREV }
				# Could probably do nested nested if -> if + else but i don't trust pdx
				# Equal -> pick random
				if = {
					limit = {
						check_variable = {
							which = ticket_weight
							which = top_ticket_weight
						}
						check_variable = {
							which = top_ticket_weight
							which = ticket_weight
						}
					}

					random_list = {
						1 = {
							set_variable = {
								which = top_ticket_weight
								which = ticket_weight
							}
							PREV = {
								save_global_event_target_as = gatcha_winner
							}
						}

						1 = { }
					}
				}
				# Greater -> just set
				else_if = {
					limit = {
						check_variable = {
							which = ticket_weight
							which = top_ticket_weight
						}
						NOT = {
							check_variable = {
								which = top_ticket_weight
								which = ticket_weight
							}
						}
					}

					set_variable = {
						which = top_ticket_weight
						which = ticket_weight
					}
					PREV = {
						save_global_event_target_as = gatcha_winner
					}
				}		
			}
		}

		clr_global_flag = reward_onyx_next
		clr_global_flag = reward_willow_next
		clr_global_flag = reward_egg_next
		clr_global_flag = reward_signet_next
		clr_global_flag = reward_digsite_next
		clr_global_flag = reward_wellspring_next
		clr_global_flag = reward_catalog_next
		clr_global_flag = reward_thor_next
		clr_global_flag = reward_wish_next

		country_event = {
			id = gacha.2
		}
	}
}

# Democracy is a lie, doge is dark descendant
country_event = {
	id = gacha.2
	title = gacha.2.t
	desc = gacha.2.d
	picture = ANGRY_MOB_eventPicture
	
	is_triggered_only = yes

	trigger = {
		ai = no
	}

	option = {
		name = gacha.2.a
		ai_chance = { factor = 1 }

		event_target:gatcha_winner = {
			# Picking reward. Set flag here so you can show the right one in the win event. Alternatively event for each reward
			random_list = {
				45 = {
					trigger = {
						NOT = {
							AND = {
								has_global_flag = reward_onyx_given
								has_global_flag = reward_willow_given
								has_global_flag = reward_egg_given
							}
						}
					}
	
					random_list = {
						1 = {
							trigger = {
								NOT = { has_global_flag = reward_onyx_given }
							}

							set_global_flag = reward_onyx_given
							set_global_flag = reward_onyx_next
						}

						1 = {
							trigger = {
								NOT = { has_global_flag = reward_willow_given }
							}

							set_global_flag = reward_willow_given
							set_global_flag = reward_willow_next
						}
						
						1 = {
							trigger = {
								NOT = { has_global_flag = reward_egg_given }
							}

							set_global_flag = reward_egg_given
							set_global_flag = reward_egg_next
						}
					}
				}
	
				35 = {
					trigger = {
						NOT = {
							AND = {
								has_global_flag = reward_signet_given
								has_global_flag = reward_digsite_given
								has_global_flag = reward_wellspring_given
							}
						}
					}
	
					random_list = {
						1 = {
							trigger = {
								NOT = { has_global_flag = reward_signet_given }
							}

							set_global_flag = reward_signet_given
							set_global_flag = reward_signet_next
						}

						1 = {
							trigger = {
								NOT = { has_global_flag = reward_digsite_given }
							}

							set_global_flag = reward_digsite_given
							set_global_flag = reward_digsite_next
						}

						1 = {
							trigger = {
								NOT = { has_global_flag = reward_wellspring_given }
							}

							set_global_flag = reward_wellspring_given
							set_global_flag = reward_wellspring_next
						}
					}
				}

				15 = {
					trigger = {
						NOT = {
							AND = {
								has_global_flag = reward_catalog_given
							}
						}
					}
	
					random_list = {
						1 = {
							trigger = {
								NOT = { has_global_flag = reward_catalog_given }
							}

							set_global_flag = reward_catalog_given
							set_global_flag = reward_catalog_next
						}
					}
				}

				5 = {
					trigger = {
						NOT = {
							AND = {
								has_global_flag = reward_thor_given
								has_global_flag = reward_wish_given
							}
						}
					}
	
					random_list = {
						1 = {
							trigger = {
								NOT = { has_global_flag = reward_thor_given }
							}

							set_global_flag = reward_thor_given
							set_global_flag = reward_thor_next
						}

						1 = {
							trigger = {
								NOT = { has_global_flag = reward_wish_given }
							}

							set_global_flag = reward_wish_given
							set_global_flag = reward_wish_next
						}
					}
				}
			}
		}
	}

	option = {
		name = gacha.2.b
		ai_chance = { factor = 1 }
		set_global_flag = reward_onyx_given
		set_global_flag = reward_onyx_next
	}
	
	option = {
		name = gacha.2.c
		ai_chance = { factor = 1 }
		set_global_flag = reward_willow_given
		set_global_flag = reward_willow_next
	}
	
	option = {
		name = gacha.2.e
		ai_chance = { factor = 1 }
		set_global_flag = reward_egg_given
		set_global_flag = reward_egg_next
	}
	
	option = {
		name = gacha.2.f
		ai_chance = { factor = 1 }
		set_global_flag = reward_signet_given
		set_global_flag = reward_signet_next
	}
	
	option = {
		name = gacha.2.g
		ai_chance = { factor = 1 }
		set_global_flag = reward_digsite_given
		set_global_flag = reward_digsite_next
	}
	
	option = {
		name = gacha.2.h
		ai_chance = { factor = 1 }
		set_global_flag = reward_wellspring_given
		set_global_flag = reward_wellspring_next
	}
	
	option = {
		name = gacha.2.i
		ai_chance = { factor = 1 }
		set_global_flag = reward_catalog_given
		set_global_flag = reward_catalog_next
	}
	
	option = {
		name = gacha.2.j
		ai_chance = { factor = 1 }
		set_global_flag = reward_thor_given
		set_global_flag = reward_thor_next
	}
	
	option = {
		name = gacha.2.k
		ai_chance = { factor = 1 }
		set_global_flag = reward_wish_given
		set_global_flag = reward_wish_next
	}
	
	after = {
		# Reset leaderboard
		A01 = { save_global_event_target_as = gatcha_leader_1 }
		A01 = { save_global_event_target_as = gatcha_leader_2 }
		A01 = { save_global_event_target_as = gatcha_leader_3 }
		A01 = { save_global_event_target_as = gatcha_leader_4 }
		A01 = { save_global_event_target_as = gatcha_leader_5 }
		A01 = { save_global_event_target_as = gatcha_leader_6 }

		# Display info event to players (single major event would be better but only does it if players have vision right?)
		hidden_effect = {
			every_country = {
				limit = {
					ai = no
				}
	
				country_event = {
					id = gacha.3
				}
			}
		}
	}
}

# Info event for players
country_event = {
	id = gacha.3
	title = gacha.3.t
	desc = gacha.3.d
	picture = ANGRY_MOB_eventPicture
	
	is_triggered_only = yes

	trigger = {
		ai = no
	}

	immediate = {
		hidden_effect = {
			set_variable = {
				which = tickets_temp
				which = tickets
			}

			set_variable = {
				tickets = 0
			}

			if = {
				limit = {
					OR = {
						OR = {
							tag = Y29
							was_tag = Y29
						}
						tag = H87
						tag = A05
						tag = Z08
						tag = A84
						tag = Y39
					}
				}
				add_ticket_effect = { tickets = 1 }
			}
		}
	}

	option = {
		name = gacha.3.a
		ai_chance = { factor = 1 }

		event_target:gatcha_winner = {
			if = {
				limit = {
					has_global_flag = reward_onyx_next
				}
				custom_tooltip = reward_onyx_tooltip
				hidden_effect = {
					set_country_flag = reward_onyx_country
				}
			} 
			else_if = {
				limit = {
					has_global_flag = reward_willow_next
				}
				custom_tooltip = reward_willow_tooltip
				hidden_effect = {
					set_country_flag = reward_willow_country
				}
			}
			else_if = {
				limit = {
					has_global_flag = reward_egg_next
				}
				custom_tooltip = reward_egg_tooltip
				hidden_effect = {
					set_country_flag = reward_egg_country
				}
			}
			else_if = {
				limit = {
					has_global_flag = reward_signet_next
				}
				custom_tooltip = reward_signet_tooltip
				hidden_effect = {
					set_country_flag = reward_signet_country
				}
			}
			else_if = {
				limit = {
					has_global_flag = reward_digsite_next
				}
				custom_tooltip = reward_digsite_tooltip
				hidden_effect = {
					set_country_flag = reward_digsite_country
				}
			}
			else_if = {
				limit = {
					has_global_flag = reward_wellspring_next
				}
				custom_tooltip = reward_wellspring_tooltip
				hidden_effect = {
					set_country_flag = reward_wellspring_country
				}
			}
			else_if = {
				limit = {
					has_global_flag = reward_catalog_next
				}
				custom_tooltip = reward_catalog_tooltip
				hidden_effect = {
					set_country_flag = reward_catalog_country
				}
			}
			else_if = {
				limit = {
					has_global_flag = reward_thor_next
				}
				custom_tooltip = reward_thor_tooltip
				hidden_effect = {
					set_country_flag = reward_thor_country
				}
			}
			else_if = {
				limit = {
					has_global_flag = reward_wish_next
				}
				custom_tooltip = reward_wish_tooltip
				hidden_effect = {
					set_country_flag = reward_wish_country
				}
			}
		}

		if = {
			# LMAO LOSERS
			limit = {
				NOT = { tag = event_target:gatcha_winner }
				check_variable = {
					which = tickets_temp
					value = 1
				}
			}

			random_list = {
				1 = {
					if = { 
						limit = { check_variable = { tickets_temp = 10 } }
						capital_scope = {
							area = {
								add_base_tax = 2
								add_base_production = 2
								add_base_manpower = 2
							}
						}
					} else = {
						capital_scope = {
							add_base_tax = 2
							add_base_production = 2
							add_base_manpower = 2
						}
					}
				}

				1 = {
					if = { 
						limit = { check_variable = { tickets_temp = 10 } }
						add_adm_power = 200
						add_dip_power = 200
						add_mil_power = 200
					} else = {
						add_adm_power = 50
						add_dip_power = 50
						add_mil_power = 50
					}
				}

				1 = {
					if = { 
						limit = { check_variable = { tickets_temp = 10 } }
						add_years_of_income = 4
					} else = {
						add_years_of_income = 1
					}
				}

				1 = {
					if = { 
						limit = { check_variable = { tickets_temp = 10 } }
						change_government_reform_progress = 200
					} else = {
						change_government_reform_progress = 50
					}
				}
			}
		}
		else = {
			if = {
				limit = {
					NOT = {
						tag = event_target:gatcha_winner
					}
				}
				custom_tooltip = gatcha_didnt_participate_tt
				add_prestige = -10
			}
			else = {

			}
		}
	}
}

country_event = {
	id = gacha.101
	title = gacha.101.t
	desc = gacha.101.d
	picture = ANGRY_MOB_eventPicture

	is_triggered_only = yes

	trigger = {
		has_country_flag = reward_signet_country
	}

	option = {
		name = gacha.101.a
		hidden_effect = {
			add_country_modifier = {
				name = hellfire_signet_modifier
				duration = -1
			}
		}
		add_adm_power = -500
		add_dip_power = -500
		add_mil_power = -500
		tooltip = {
			add_country_modifier = {
				name = hellfire_signet_modifier_very_real
				duration = -1
			}
		}
	}
	
}